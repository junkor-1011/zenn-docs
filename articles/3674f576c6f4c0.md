---
title: "aws cdkã®è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’vitestã§å®Ÿè¡Œã™ã‚‹"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics:
  - awscdk
  - cdk
  - vitest
  - typescript
published: false
---

## å‹•æ©Ÿ

cdk ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ(TypeScript)ã¯ç«‹ã¡ä¸Šã’ãŸã¨ãã« jest(ts-jest)ã‚’ä½¿ã†å½¢ã§è‡ªå‹•ãƒ†ã‚¹ãƒˆã®é››å½¢ãŒè‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã€‚
åŸºæœ¬ãã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã«æ”¹ä¿®ã—ã¦ã„ãå½¢ã§å›°ã‚‰ãªã„ã€‚

ãŒã€ts-jest ã¯å®Ÿè¡ŒãŒé…ã‹ã£ãŸã‚Šã™ã‚‹ã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’ã—ã¦ãã‚Œã‚‹ã¨ã„ã†ã®ã¯ã‚ã‚‹ãŒã€cdk ã«ãŠã‘ã‚‹ãƒ†ã‚¹ãƒˆã§ã¯æ©æµã¯ã‚ã¾ã‚Šå¤šããªã„æ°—ã‚‚ã™ã‚‹ã€‚

TypeScript ã‚’åˆ©ç”¨ã™ã‚‹ cdk ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ãƒ“ãƒ«ãƒ‰ã« esbuild ãŒä½¿ã‚ã‚Œã‚‹ãŸã‚ã€é€Ÿåº¦ãŒå•é¡Œã§ã‚ã‚Œã°[esbuild-jest](https://github.com/aelbore/esbuild-jest)ã‚’ä½¿ã†æ‰‹ã‚‚ã‚ã‚‹ã€‚ãŒã€åŸ·ç­†æ™‚ç‚¹ã«ãŠã‘ã‚‹æœ€çµ‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒ 2021 å¹´ 5 æœˆã ã£ãŸã‚Šã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒé »ç¹ã§ãªãå¿ƒè¨±ãªã‹ã£ãŸã‚Šã™ã‚‹ã€‚

ãã“ã§ã€[vitest](https://vitest.dev/)ã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚

## æ¤œè¨¼ç’°å¢ƒ

- Fedora37
- node v18.15.0(LTS)
- pnpm@8.1.1
  - ã‚ã¾ã‚Šæœ¬è³ªã§ã¯ãªã„ãŒä»Šå›ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã« pnpm ã‚’ä½¿ã†
  - (npm ã‚„ yarn ã‚’ä½¿ã†äººã¯é©å½“ã«èª­ã¿æ›¿ãˆã¦ãã ã•ã„)
- aws-cdk@2.73.0

## å®Ÿè¡Œ

### (1)åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

cdk ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç«‹ã¡ä¸Šã’ã‚‹é©å½“ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª(ä»Šå›ã¯`cdk-app`ã¨ã™ã‚‹)ã‚’ä½œæˆã—ã€ä½¿ç”¨è¨€èªã« TypeScript ã‚’æŒ‡å®šã—ã¦ç«‹ã¡ä¸Šã’ã‚‹

```sh
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç«‹ã¡ä¸Šã’ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p /path/to/cdk-app
cd /path/to/cdk-app

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç«‹ã¡ä¸Šã’
npx aws-cdk@2.73.0 init --language typescript

rm package-lock.json # pnpmã‚’ä½¿ã†ãŸã‚ã€‚npmã‚’ä½¿ã†äººã¯ãã®ã¾ã¾æ®‹ã›ã°OK
pnpm install # ä½¿ã†packageManagerã«å¿œã˜ã¦é©å½“ã«èª­ã¿æ›¿ãˆ(ä»¥é™ã‚‚åŒæ§˜)
```

ã“ã“ã§ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜

```sh
tree --gitignore
# .
# â”œâ”€â”€ README.md
# â”œâ”€â”€ bin
# â”‚Â Â  â””â”€â”€ cdk-app.ts
# â”œâ”€â”€ cdk.json
# â”œâ”€â”€ jest.config.js
# â”œâ”€â”€ lib
# â”‚Â Â  â””â”€â”€ cdk-app-stack.ts
# â”œâ”€â”€ package.json
# â”œâ”€â”€ pnpm-lock.yaml
# â”œâ”€â”€ test
# â”‚Â Â  â””â”€â”€ cdk-app.test.ts
# â””â”€â”€ tsconfig.json
#
# 4 directories, 9 files
```

ã¾ãŸã€`package.json`ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

```json:package.json
{
  "name": "cdk-app",
  "version": "0.1.0",
  "bin": {
    "cdk-app": "bin/cdk-app.js"
  },
  "scripts": {
    "build": "tsc",
    "watch": "tsc -w",
    "test": "jest",
    "cdk": "cdk"
  },
  "devDependencies": {
    "@types/jest": "^29.4.0",
    "@types/node": "18.14.6",
    "jest": "^29.5.0",
    "ts-jest": "^29.0.5",
    "aws-cdk": "2.73.0",
    "ts-node": "^10.9.1",
    "typescript": "~4.9.5"
  },
  "dependencies": {
    "aws-cdk-lib": "2.73.0",
    "constructs": "^10.0.0",
    "source-map-support": "^0.5.21"
  }
}
```

æ¬¡ã«ã€jest ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ vitest ã‚’å°å…¥ã™ã‚‹ã€‚

```sh
# jestã®configã‚’æ¶ˆå»
rm jest.config.js
```

```diff:package.json
  "scripts": {
  // testã‚³ãƒãƒ³ãƒ‰ã‚’jestã‹ã‚‰vitestã«åˆ‡ã‚Šæ›¿ãˆã¦ãŠã
-   "test": "jest",
+   "test": "vitest --run",

  "devDependencies": {
  // jesté–¢ä¿‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’devDepenciesã‹ã‚‰æ¶ˆã—ã¦ãŠã
-   "@types/jest": "^29.4.0",
-   "jest": "^29.5.0",
-   "ts-jest": "^29.0.5",
```

vitest ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```sh
pnpm add -D vite vitest
```

æ¬¡ã« vitest ã® config ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚

https://vitest.dev/config/

ã‚’å‚ç…§ã—ã¤ã¤ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ä½œã‚‹ã€‚

```typescript:vitest.config.ts
import 'vitest/config';
import { defineConfig, type UserConfig } from 'vite';

export default defineConfig({
  test: {
    globals: true, // describeã‚„test, it, expectãªã©ã‚’importç„¡ã—ã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
    environment: 'node',
    include: ['./test/**/*.(test|spec).ts'], // å…ƒã®jestã®è¨­å®šãŒ`test/`ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹è¨­å®šã ã£ãŸã®ã§åˆã‚ã›ã¦ã„ã‚‹
  },
});
```

ã“ã‚Œã§ã€`pnpm test`ã‚’å®Ÿè¡Œã™ã‚‹ã¨

```sh
pnpm test

#  RUN  v0.29.8 /home/wsl-user/tmp/cdk-tmp/cdk-app
#
#  âœ“ test/cdk-app.test.ts (1)
#
#  Test Files  1 passed (1)
#       Tests  1 passed (1)
#    Start at  00:08:35
#    Duration  741ms (transform 46ms, setup 0ms, collect 12ms, tests 3ms)
```

ã®ã‚ˆã†ã«ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•ã§å®Ÿè¡Œã§ãã‚‹ã€‚

ãªãŠã€`vitest.config.ts`ã«ãŠã„ã¦`globals: true`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ import ç„¡ã—ã§ test ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ãŒã€ã“ã®ã¾ã¾ã ã¨ã‚¨ãƒ‡ã‚£ã‚¿ãªã©ãŒ vitest ã®å‹ã‚’èª­ã¿è¾¼ã‚ãšã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãŒå‡ºãŸã‚Šã™ã‚‹ã®ã§ã€å¿…è¦ã§ã‚ã‚Œã°`tsconfig.json`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹

```diff:tsconfig.json
// compilerOptionsã§ä»¥ä¸‹(typeséƒ¨åˆ†)ã‚’è¿½è¨˜
  "compilerOptions": {
+   "types": [
+     "vitest/globals"
+   ],
  // ...
```

ã‚ã‚‹ã„ã¯ã€å„ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§

```typescript
import { describe, test, expect, vi } from "vitest";

describe("***", () => {
  test("test-case-***", () => {
    // ...
  });
});
```

ã®ã‚ˆã†ã«ã€æ˜ç¤ºçš„ã«`vitest`ã‹ã‚‰ import ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

å‚è€ƒ:

https://developer.mamezou-tech.com/blogs/2022/12/28/vitest-intro/

https://isub.co.jp/typescript/vitest-get-started/

### (2)snapshot ãƒ†ã‚¹ãƒˆã®å°å…¥

https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/testing.html

https://pages.awscloud.com/rs/112-TZM-766/images/CDK%E3%81%A7%E3%82%82%E3%83%86%E3%82%B9%E3%83%88%E3%81%8C%E3%81%97%E3%81%9F%E3%81%84.pdf

ãªã©ã§è¨€åŠã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€cdk ã«ãŠã‘ã‚‹æœ‰åŠ¹ãªãƒ†ã‚¹ãƒˆæ‰‹æ³•ã¨ã—ã¦

- fine-grained assertions
- snapshot testing

ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã‚‹ã€‚

å‰è€…ã¯ç‰¹ã« vitest å›ºæœ‰ã®è©±ã¯å‡ºã¦æ¥ãªã„ï¼Ÿã¨æ€ã‚ã‚Œã‚‹ã®ã§ã€å¾Œè€…ã«ã¤ã„ã¦å°‘ã—å–ã‚Šä¸Šã’ã‚‹ã€‚

snapshot ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€`test`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«(`test/snapshot.test.ts`)ã‚’è¿½åŠ ã™ã‚‹ã€‚

```typescript:test/snapshot.test.ts
import * as cdk from 'aws-cdk-lib';
import { Template } from 'aws-cdk-lib/assertions';
import { CdkAppStack } from '../lib/cdk-app-stack';

test('snapshot test', () => {
  const app = new cdk.App();
  const stack = new CdkAppStack(app, 'TestStack');
  const template = Template.fromStack(stack).toJSON();

  expect(template).toMatchSnapshot();
});
```

ã“ã‚Œã§

```sh
pnpm test
```

ã¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ snapshot ãƒ†ã‚¹ãƒˆãŒä¸€ç·’ã«è¡Œã‚ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã€`__snapshots__`ä»¥ä¸‹ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå†…å®¹ãŒè‡ªå‹•ã§ä¿å­˜ã•ã‚Œã‚‹ã€‚

snapshot ã®å†…å®¹ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã¯

```sh
pnpm test -- -u
```

ãªã©ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã€‚

ã“ã“ã¾ã§ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜:

```sh
tree --gitignore
# .
# â”œâ”€â”€ README.md
# â”œâ”€â”€ bin
# â”‚Â Â  â””â”€â”€ cdk-app.ts
# â”œâ”€â”€ cdk.json
# â”œâ”€â”€ lib
# â”‚Â Â  â””â”€â”€ cdk-app-stack.ts
# â”œâ”€â”€ package.json
# â”œâ”€â”€ pnpm-lock.yaml
# â”œâ”€â”€ test
# â”‚Â Â  â”œâ”€â”€ __snapshots__ â˜…è‡ªå‹•ç”Ÿæˆ
# â”‚Â Â  â”‚Â Â  â””â”€â”€ snapshot.test.ts.snap â˜…è‡ªå‹•ç”Ÿæˆ
# â”‚Â Â  â”œâ”€â”€ cdk-app.test.ts
# â”‚Â Â  â””â”€â”€ snapshot.test.ts â˜…è¿½åŠ 
# â”œâ”€â”€ tsconfig.json
# â””â”€â”€ vitest.config.ts
#
# 5 directories, 11 files
```

(...ã¨ã“ã“ã¾ã§ã¯åˆ¥ã« vitest å›ºæœ‰ã®è©±ã¯å‡ºã¦æ¥ãªã„ãŒã€ä»¥é™ã®æ‰‹é †ã§ vitest ç‰¹æœ‰ã®å¯¾å‡¦ãŒå¿…è¦ãªç®‡æ‰€ãŒå‡ºã¦ãã‚‹ã®ã§é †æ¬¡ç´¹ä»‹ã™ã‚‹)

#### asset(Lambda)ã®è¿½åŠ 

esbuild ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒå¿…è¦ãª asset ã¨ã—ã¦ Lambda ã‚’è¿½åŠ ã—ã€cdk ã§ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

#### snapshot test ã«ãŠã‘ã‚‹ asset ã®å¤‰æ›´ã®ç„¡è¦–

https://dev.classmethod.jp/articles/aws-cdk-v2-unit-test-ignore-assets/

ã¨åŒã˜ã“ã¨ã‚’ã‚„ã‚‹éš›ã«ã€vitest ã§ã¯å…¨ãåŒã˜ã‚ˆã†ã«ã¯ã„ã‹ãªã„ã®ã§ç‰¹æœ‰ã®å¯¾å¿œã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚
