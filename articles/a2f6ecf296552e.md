---
title: "ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ESMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ(TypeScript)ã®ãƒ†ã‚¹ãƒˆã‚’ts-jestã¨esbuild-jestã§å®Ÿè¡Œã™ã‚‹"
emoji: "ğŸš€"
type: "tech"
topics:
  - "javascript"
  - "typescript"
  - "jest"
  - "nodejs"
published: true
published_at: "2023-02-05 17:13"
---

https://zenn.dev/junkor/articles/2bcd22ca08d21d
ã®ç¶šãã€‚

jestã§å®Ÿè¡Œã™ã‚‹éš›ã‚‚è‰²ã€…ãƒãƒã‚Šã©ã“ã‚ãŒã‚ã£ãŸã®ã§ãƒ¡ãƒ¢ã€‚

TypeScriptãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§ã€[ts-jest](https://github.com/kulshekhar/ts-jest)ã¨[esbuild-jest](https://github.com/aelbore/esbuild-jest)ã®ãã‚Œãã‚Œã‚’ä½¿ã£ã¦ã‚„ã£ã¦ã¿ãŸã€‚

## æ¤œè¨¼ç’°å¢ƒ

- Linux: Ubuntu22.04LTS @WSL2ï¼ˆWindows11ï¼‰
- nodejs 18.13.0LTS
- pnpm@7.26.3
  - npmã‚„yarnã‚’ä½¿ã£ã¦ã„ã‚‹äººã¯é©å®œèª­ã¿æ›¿ãˆã¦ãã ã•ã„
- (TypeScript: 4.9.5)

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

package.jsonã§`"type": "module"`ã‚’è¨­å®šã—ã€tsconfig.jsonã¯[å‰å›è¨˜äº‹](https://zenn.dev/junkor/articles/2bcd22ca08d21d#tsconfig.json)ã®ã‚ˆã†ãªæ„Ÿã˜
ã§æ›¸ã„ã¦ãŠã

### ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

ESMç‰¹æœ‰ã®æ©Ÿèƒ½ã‚’ä½¿ãˆã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã„ã®ã§ã€æ„å‘³ã¯ç„¡ã„ãŒtop-level-awaitã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒã‚¨ãƒ©ãƒ¼ç„¡ã—ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

```typescript:tla.test.ts
/** 10msecå¾…æ©Ÿã—ãŸå¾Œã«æ–‡å­—åˆ—ã‚’top-level-awaitã§å–å¾— */
const awaitedValue: string = await (async () => {
  await new Promise((resolve) => setTimeout(resolve, 10));
  return 'awaited';
})();

test('top level await', () => {
  expect(awaitedValue).toBe('awaited');
});
```

### ts-jestã§å®Ÿè¡Œ

ä¸‹è¨˜ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ï¼š

```sh
pnpm add -D jest @types/jest ts-jest ts-jest-resolver
```

[ts-jest-resolver](https://github.com/VitorLuizC/ts-jest-resolver)ã¯ã€è‡ªä½œãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãªã©ã®importã§æ‹¡å¼µå­.jsãªã©ã‚’ã¤ã‘ã¦ã„ã‚‹ã®ã‚’æ­£ã—ãèª­ã¿è¾¼ã‚€ãŸã‚ã«å¿…è¦ã€‚

æ¬¡ã«`jest.config.cjs`ã‚’è¨˜è¿°ã™ã‚‹ã€‚ï¼ˆâ€»ESMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã®ã§æ‹¡å¼µå­ã¯cjsã«ã™ã‚‹å¿…è¦ï¼‰

```javascript:jest.config.cjs
/** @type {import('jest').Config} */
const config = {
  resolver: 'ts-jest-resolver',
  extensionsToTreatAsEsm: ['.ts'],
  transform: {
    '^.+\\.(t|j)sx?$': [
      'ts-jest',
      { useESM: true }
    ],
  },
};

module.exports = config;
```

- resolverã§å…ˆç¨‹ã®`ts-jest-resolver`ã‚’æŒ‡å®šã—ã€jestãŒæ­£ã—ããƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®importãŒå‡ºæ¥ã‚‹ã‚ˆã†ã«ã™ã‚‹
- extensionsToTreatAsEsmã§æ‹¡å¼µå­ãŒ`.ts`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ESMã¨ã—ã¦æ‰±ã†ã‚ˆã†ã«æŒ‡å®šã—ã¦ã„ã‚‹
- transformã§`ts-jest`ã‚’æŒ‡å®šã—ã¦ãŠã‚Šã€æ›´ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§`useESM: true`ã‚’æŒ‡å®šã—ã¦ã„ã‚‹

ts-jestã®ESM Supportã®ãƒšãƒ¼ã‚¸ï¼š
https://kulshekhar.github.io/ts-jest/docs/guides/esm-support
ã‚‚å‚ç…§ã®ã“ã¨ã€‚

æœ€ä½é™ã®è¨­å®šã¯ä»¥ä¸Šã ãŒã€å®Ÿè¡Œã®éš›ã«ã¯ã¾ã æ³¨æ„ç‚¹ãŒã‚ã‚Šã€
https://jestjs.io/ja/docs/ecmascript-modules
ãªã©ã«è¨˜è¿°ã•ã‚Œã‚‹ã‚ˆã†ã«ã€å°‘ãªãã¨ã‚‚node18.13.0ã®æ™‚ç‚¹ã§ã¯`NODE_OPTIONS=--experimental-vm-modules`ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã™ãªã‚ã¡ã€

```diff:package.json
  "scripts": {
    // ...
+   "test": "NODE_OPTIONS='--experimental-vm-modules' jest"
  },
```

ãªã©ã®ã‚ˆã†ã«ã—ã¦ã€jestå®Ÿè¡Œæ™‚ã«å½“è©²ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆã—ã¦å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
ã‚»ãƒƒãƒˆã—ãªã„å ´åˆã€`SyntaxError: Cannot use import statement outside a module`ã¨ã‹`SyntaxError: Cannot use 'import.meta' outside a module`ã€`ReferenceError: await is not defined`ãªã©è‰²ã€…ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

ã¨ã‚Šã‚ãˆãšä»¥ä¸Šã®ã‚ˆã†ãªæ„Ÿã˜ã§ãªã‚“ã¨ã‹å‹•ãã‚ˆã†ã«ãªã‚‹ã€‚

```sh
pnpm test path/to/tla.test.ts

> test-esm-app@1.0.0 test /home/xxxxxx/test-esm-app
> NODE_OPTIONS='--experimental-vm-modules' jest "test/unit/tla.test.ts"

(node:29140) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  path/to/tla.test.ts
  âœ“ top level await (7 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        1.584 s, estimated 2 s
```

#### ãã®ä»–æ³¨æ„

https://jestjs.io/ja/docs/ecmascript-modules#differences-between-esm-and-commonjs
ã«è¨˜è¼‰ã®é€šã‚Šã ãŒã€ESMãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’jestã§å®Ÿè¡Œã™ã‚‹éš›ã«ã¯ã„ãã¤ã‹commonjsã®ã¨ãã¨é•ã„ãŒã‚ã‚Šã€ä¾‹ãˆã°jestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’importç„¡ã—ã§ä½¿ã†ã“ã¨ãŒå‡ºæ¥ãªã‹ã£ãŸã‚Šã™ã‚‹ã€‚

```typescript
// å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¾‹ã‚ˆã‚Š
import { jest } from "@jest/globals"; // æ˜ç¤ºçš„ã«importã™ã‚‹

jest.useFakeTimers();

// etc.

// alternatively
import.meta.jest.useFakeTimers();

// jest === import.meta.jest => true
```

ãªãŠã€æ˜ç¤ºçš„ã«importã™ã‚‹å ´åˆã ãŒã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«pnpmã‚’ä½¿ã£ã¦ã„ã¦ã‹ã¤[node-linker](https://pnpm.io/ja/npmrc#node-linker)è¨­å®šãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãªã£ã¦ã„ã‚‹å ´åˆã¯node_modulesã®æ§‹é€ ä¸Šã®å•é¡Œã§ãã®ã¾ã¾`import {jest} from '@jest/globals'`ã‚’ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ãªã„ã€‚
ã“ã®å ´åˆã¯

1. .npmrcã«`node-linker=hoisted`ã‚’è¨­å®šã™ã‚‹
2. `pnpm add -D @jest/globals`ã‚’ã—ã¦æ˜ç¤ºçš„ã«`@jest/globals`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
3. ä¸Šè¨˜ä¾‹ã®`alternatively`ã¨ãªã£ã¦ã„ã‚‹ã€`import.meta.jest.***`ã‚’ä½¿ã£ã¦ä»£æ›¿ã™ã‚‹ã€‚

ãªã©ã®å¯¾ç­–ã‚’å–ã‚‹å¿…è¦ãŒå‡ºã¦ãã‚‹ã€‚

### esbuild-jestã‚’ä½¿ã†å ´åˆ

ts-jestã¯å®Ÿè¡ŒãŒé…ã„ã®ã§ã€é«˜é€ŸåŒ–ãªã©ã®ç›®çš„ã§[esbuild-jest](https://www.npmjs.com/package/esbuild-jest)ã‚‚ä½¿ã£ã¦ã¿ã‚‹ã€‚
ï¼ˆæœ€çµ‚æ›´æ–°ãŒ2021å¹´3æœˆã§åœæ»æ°—å‘³ãªã¨ã“ã‚ã¯å¾®å¦™ã ãŒã€‚ã€‚ã€‚ï¼‰

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ï¼š

```sh
pnpm add -D jest @types/jest esbuild-jest ts-jest-resolver
```

ts-jestã‚’esbuildã«å¤‰ãˆãŸã ã‘ã¨ãªã£ã¦ã„ã‚‹ã€‚

jest.config.cjsã®å†…å®¹ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ï¼š

```javascript:jest.config.cjs
/** @type {import('jest').Config} */
const config = {
  resolver: 'ts-jest-resolver',
  extensionsToTreatAsEsm: ['.ts'],
  transform: {
    '^.+\\.(t|j)sx?$': [
      'esbuild-jest',
      {
        // sourceMaps: true,  // â†å¿…è¦ãªå ´åˆ
        format: 'esm',
        target: 'es2022',
      },
    ],
  },
};

module.exports = config;
```

ts-jestã®å ´åˆã¨å·®åˆ†ãŒã‚ã‚‹ã®ã¯`transform`éƒ¨åˆ†ã ã‘ã€‚

- ts-jestã§ãªãesbuild-jestã‚’transformã«ä½¿ã†ã‚ˆã†ã«ã—ã¦ã„ã‚‹
- format: esmã‚’æŒ‡å®šã™ã‚‹
- target: es2022ä»¥é™ã‚’æŒ‡å®šã™ã‚‹

ã‚ãŸã‚ŠãŒæœ€ä½é™å¿…è¦ã«ãªã‚‹ã€‚

ãã‚Œä»¥é™ã¯ts-jestã®å ´åˆã¨åŒã˜ã§ã€
jestå®Ÿè¡Œæ™‚ã«`NODE_OPTIONS=--experimental-vm-modules`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã‚Šã€jestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®åˆ©ç”¨ã«é–¢ã—ã¦ã®æ³¨æ„ç‚¹ã‚‚å…±é€šã¨ãªã‚‹ã€‚

ã“ã‚Œã§åŒã˜ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€

```sh
pnpm test path/to/tla.test.ts

> test-esm-app@1.0.0 test /home/xxxxxx/test-esm-app
> NODE_OPTIONS='--experimental-vm-modules' jest "test/unit/tla.test.ts"

(node:29722) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
 PASS  path/to/tla.test.ts
  âœ“ top level await (2 ms)

Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        0.227 s, estimated 1 s
```

ç„¡äº‹ã«å‹•ä½œã—ã€å®Ÿè¡Œæ™‚é–“ãŒç´„1.5ç§’ â†’ ç´„0.2ç§’ã¨é«˜é€ŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚
ï¼ˆãŸã ã—ã€ãã®åˆ†å‹ãƒã‚§ãƒƒã‚¯ã¯ã•ã‚Œãªããªã£ã¦ã„ã‚‹ã¯ãšãªã®ã§æ³¨æ„ï¼‰

## é›‘æ„Ÿ

ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®æˆç†Ÿåº¦åˆã„ã‚„å…ˆè¡Œäº‹ä¾‹ã®å¤šã•ãªã©ã‚’è€ƒãˆã¦jestã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ãŸãŒã€vitestã‚‚ã‹ãªã‚Šè‰¯ã•ãã†ã€‚

https://vitest.dev/

jestã ã¨ESMå¯¾å¿œã¯ã¾ã Experimentalæ‰±ã„ã ãŒvitestã ã¨ãƒã‚¤ãƒ†ã‚£ãƒ–ã§ESMã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ãï¼Ÿã€æ‰‹å…ƒã§å°‘ã—ã ã‘è©¦ã—ã¦ã¿ãŸæ„Ÿã˜ã§ã¯ç‰¹åˆ¥ãªè¨­å®šã¯ä¸è¦ãã†ã ã£ãŸã€‚
ã“ã†ã„ã£ãŸãƒ„ãƒ¼ãƒ«ãŒã‚ˆã‚Šæˆé•·ã—ã¦ãã‚Œã‚‹ã¨è‰²ã€…æ¥½ã«ãªã£ã¦ã„ãã‹ã‚‚ã—ã‚Œãªã„ã€‚
