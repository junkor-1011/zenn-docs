---
title: "images.linuxcontainers.orgを利用して手軽に色々なWSL2ディストリビューションを作る"
emoji: "🤖"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["wsl2", "wsl"]
published: false
---

WSL2ディストリビューションに関して、
Microsoft Storeからインストールできるものや、あるいは
`wsl --list --online`で表示されるリスト以外のディストリビューションをインストールしたくなったり、
あるいは同じ種類のディストリビューションを複数個インストールしたくなったりすることがある(目的別にUbuntu24.04を2つ並用する、とか)。

というときの選択肢を探ってみる。

## 方法

https://learn.microsoft.com/ja-jp/windows/wsl/use-custom-distro

に記載されているように、`wsl --import`コマンドでLinuxのコンテナの中身を含むtarファイルを取り込むことで任意のLinuxディストリビューションをWSL2に登録することができる。

上記のリンク先の解説ではDockerコンテナを使っているが、
`linuxcontainers.org`で公開されているイメージ:

https://images.linuxcontainers.org/

をそのまま`wsl --import`コマンドで取り込むことができ、即座に対応するWSL2ディストリビューションを作ることができる。

公開されているイメージは

- ubuntu
- debian
- fedora
- archlinux
- alpine
- almalinux
- rockylinux
- amazonlinux
- (その他数え切れないくらい多数)

といった感じで、かなり多くの選択肢がある。
(もちろん無いものもあるにはあるが)

所望のイメージのページに行き、`rootfs.tar.xz`をダウンロードし、

```powershell:powershell
wsl --import <登録するディストリビューション名> <仮想ディスクなどの保存場所のパス> <rootfs.tar.xzの保存パス>
```

のようにして、`wsl --import`の第3引数でダウンロードした`rootfs.tar.xz`を指定して取り込むと、所望のWSL2ディストリビューションをインポート出来る。

手元ではとりあえずubuntu-24.10(oracular), fedora41, amazonlinux2023, archlinuxあたりをインポートしてみたが、どれも問題なく起動した。

## (おまけ)ディストリビューションのセットアップ・プロビジョニング

全部のイメージがそうかまでは確認できていないが、見た範囲ではどのディストリビューションでもユーザーがrootしか存在しないため、
実用的にはユーザーの作成などを行う必要がある。
また、パッケージの追加や設定ファイルの記入なども必要になる可能性がある。

ここで、WSL2ではcloud-init:

https://cloudinit.readthedocs.io/en/latest/reference/datasources/wsl.html

https://documentation.ubuntu.com/wsl/en/latest/tutorials/cloud-init/

が使えるため、これを試してみる。

cloud-initを動かすには対象のディストリビューション側でcloud-initがインストールされていることと、
`systemd`が有効化されていることが必要となる。

前者については、 images.linuxcontainers.org で"cloud"と書かれているものを選ぶと、初めからインストールされていることが多い。
もし入っていなかったら適宜aptとかdnfの類でインストールして使えるようにしておく。

後者について、手動で`wsl --import`によって登録したディストリビューションではsystemdが有効化されていないため、
以下のように`/etc/wsl.conf`を追加・記述しておく。

```toml:/etc/wsl.conf
[boot]
systemd = true
```

これで、対象のWSL2ディストリビューションを再起動すればsystemdが有効化される。

次に、cloud-init用の設定ファイルを記述する。

設定ファイルの置き場所およびファイル名は所定の規則に従う必要があり、
`%USERPROFILE\.cloud-init\<登録したWSL2ディストリビューション名>.user-data`
に記述する必要がある。
(`%USERPROFILE%`はWindowsにおけるホームディレクトリのようなもので、多くの場合では`C:\Users\<ユーザー名>`などを指す)

後は`<ディストリビューション名>.user-data`の中身(cloud-config)をyaml形式で記述していくことで自動セットアップができるが、
ここでは一例として

- ユーザーの作成
  - sudo権限ありで、password無しで昇格できるようにする
  - `/etc/wsl.conf`への追記も行い、wsl2で起動した際のデフォルトユーザーにする
  - (その他、いくつか適当に設定)
- パッケージの追加
  - デフォルトではインストールされていないが、aptやdnfの類でインストール出来るものをいくつか自動でインストールするようにする

といった内容のものを作成・適用してみる。

```yaml:user-data
#cloud-config
timezone: Asia/Tokyo
locale: en_US.utf8
users:
  - name: wsl-user # ここではwsl-userという名前のユーザーを作成する
    shell: /usr/bin/fish # 深い意味は無いが、例として後でインストールするfishをデフォルトシェルに指定してみる
    groups: [adm, sudo, wheel]
    sudo:
      - ALL=(ALL) NOPASSWD:ALL
    uid: 1000 # uidも設定できる
packages:
  - fish
  - htop
  - fzf
  - ripgrep
write_files:
  - path: /etc/wsl.conf
    append: true
    content: |
    [user]
    default = wsl-user
# 初回設定時に実行したい操作などがあれば、runcmdで実行できる
# runcmd:
#   - command arg1 arg2
```

## 参考

### (検証環境)

- Windows11(x86_64)
  - バージョン23H2 (OSビルド22631.4460)
- wslバージョン:

```powershell
wsl --version
WSL バージョン: 2.3.26.0
カーネル バージョン: 5.15.167.4-1
WSLg バージョン: 1.0.65
MSRDC バージョン: 1.2.5620
Direct3D バージョン: 1.611.1-81528511
DXCore バージョン: 10.0.26100.1-240331-1435.ge-release
Windows バージョン: 10.0.22631.4460
```

### 参考1 昔書いた記事

https://zenn.dev/junkor/articles/e2b8d7815bd44a

Dockerfileを使ってイメージ内容を自由にカスタマイズできる、という記事。
極めて高い自由度がメリットだが、一方で、Dockerで使われるベースイメージは一般にごく最低限のパッケージしか入っていないため、WSL2のような開発や普段使い?するためには色々と不足や差分があり、カスタマイズ(Dockerfileの記入)が大変なところがあった。
(あと、`docker export`などを行うのが面倒)

images.linuxcontainers.org で公開されているイメージはそのまま`wsl --import`することができ、
dockerイメージよりは最低限使いそうなパッケージが入っていることが多そう?なので、より手軽に色々なディストリビューションを導入できると思われる。

### 参考2 distod

https://github.com/nullpo-head/wsl-distrod

WSL2でsystemdを使えるようにする他、
WSL2に[linuxcontainers.org](https://linuxcontainers.org/)で入手できるあらゆるイメージをWSL2にインストールできるツールらしい。
(まだwsl2で満足にsystemdが使えなかったときに、systemdを使う手段として使われていた気がする。)

前者の機能のためにこのツールを存在を知ったが、今回の記事の内容は後者の方の機能に着想を得ている。
