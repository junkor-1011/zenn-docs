---
title: "Hyper-VでLinux環境(ArchLinux)を立ち上げてみる"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["archlinux", "hyperv", "windowsterminal", "wsl"]
published: false
---

特にArchLinuxに詳しいとかでは無いが、なんとなくやってみたくなったのでメモ。

## 方針・目標など

WindowsからHyper-V上のarchlinuxへの接続にはsshを使う。
Windows Terminalのプロファイルに登録しておくことで、WSLを起動するのと大きくは変わらない使用感で楽に起動できるようにする。

ゆるふわ勢なのでインストールには`archinstall`:

https://wiki.archlinux.org/title/archinstall

https://github.com/archlinux/archinstall

を使ってあまり頑張らずにやる。
https://github.com/archlinux/archinstall
([Manjaro](https://manjaro.org/)にDesktop無しのサーバー版があればそれで良かったような、という気がする)

ユーザーの作成やssh周りの設定などは、鍵の登録を自動化しやすかったりパッケージインストールなど諸々のセットアップができるので`cloud-init`を使って行う。

https://cloud-init.io/

(他のディストリビューションでも知見を使い回しやすいのも大きい)

## 手順

![](https://storage.googleapis.com/zenn-user-upload/79817e604016-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/4a10cd833a77-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/98b35138e09b-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/0476bd0341d5-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/8cff635f7cd3-20240517.png)

https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2024.05.01/

![](https://storage.googleapis.com/zenn-user-upload/b59146ec2ae8-20240517.png)

↑Linuxを起動する際は必ず「セキュアブート」をOFFにする
(デフォルトではONになっているが、OFFにしないと起動できない)

![](https://storage.googleapis.com/zenn-user-upload/b115c8ea559b-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/403fe732309c-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/8d6c845a1c71-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/4016c9a388ef-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/ac4558d9c11b-20240517.png)

ここでは"Use a best-effort default partition layout"を選択する

![](https://storage.googleapis.com/zenn-user-upload/68bfd9c8441f-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/805e36699d7e-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/1452a3b2fece-20240517.png)

ここでは"no"を選択して同じパーティションとした

![](https://storage.googleapis.com/zenn-user-upload/8d6ee61e0194-20240517.png)

ホスト(Windows)側からssh接続したいのでTypeは"Server"の"sshd"を選択

![](https://storage.googleapis.com/zenn-user-upload/4756efe413ed-20240517.png)

"Additional packages"について、

- `cloud-init`
    - (後でプロビジョニングする用)
- `cloud-guest-utils`
    - growpart(後からディスクを拡張した際に、自動でパーティションサイズを調整してくれる)などを使えるようにしておく
- `vim`, `less`は一応入れておく
- `xorg-xeyes`: x11の動作確認をしたいので(後でcloud-initで入れても良いが)

今回`cloud-init`を使う予定なのでここでインストールするものは最小限にしているが、
ここで好きに色々インストールしても良い

![](https://storage.googleapis.com/zenn-user-upload/42352fc71265-20240517.png)

`user_configuration.json`および、`user_credentials.json`は適当に保存しておく

![](https://storage.googleapis.com/zenn-user-upload/7a0e25f19fc7-20240517.png)

インストールが完了したら、`chroot`して新しくインストールしたものにログインして必要な初期セットアップができる。

今回は`cloud-init`のservice有効化をしたいのでyes。

![](https://storage.googleapis.com/zenn-user-upload/02013d407dee-20240517.png)

```sh
systemctl enable cloud-init
systemctl enable cloud-init-local
systemctl enable cloud-config
systemctl enable cloud-final
```

を順次実行する。
(他にやりたいことがあれば適宜やっておく)

exitで抜けると"Installation completed without any errors. You may now reboot."と出る。

![](https://storage.googleapis.com/zenn-user-upload/1a785efa1ab7-20240517.png)

今回は先ほど保存した`user_configuration.json`と`user_credentials.json`を回収したのですぐにはrebootしない。

まずは仮想マシンのIPアドレスを`ip a`などで調べる。

次に、おそらくデフォルトでpythonが保存されているはずなので、

```sh
python -m http.server
```

を保存したファイルがあるディレクトリで実行し、8000ポートで公開する。

![](https://storage.googleapis.com/zenn-user-upload/19bb51723612-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/38e31da4bac8-20240517.png)

Windows側で"http://<先ほど調べたIPアドレス>:8000"にアクセスすると、
`user_configuration.json`と`user_configuration.json`が見えるのでここでダウンロードしておく。
(次回以降、今回と同じ設定を使って素早くインストールできる。)

上記のファイルも保存し終えたら一旦終了する。

![](https://storage.googleapis.com/zenn-user-upload/5d03136dd1d8-20240517.png)

仮想マシンにアタッチされているインストールメディア(isoファイル)を除去し、
代わりに先ほど`genisoimage`を使って作成したisoファイルをアタッチする。
