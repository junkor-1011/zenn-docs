---
title: "Hyper-VでLinux環境(ArchLinux)を立ち上げてみる"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["archlinux", "hyperv", "windowsterminal", "wsl"]
published: false
---

特にArchLinuxに詳しいとかでは無いが、なんとなくやってみたくなったのでメモ。

## 方針・目標など

WindowsからHyper-V上のarchlinuxへの接続にはsshを使う。
Windows Terminalのプロファイルに登録しておくことで、WSLを起動するのと大きくは変わらない使用感で楽に起動できるようにする。

ゆるふわ勢なのでインストールには`archinstall`:

https://wiki.archlinux.org/title/archinstall

https://github.com/archlinux/archinstall

を使ってあまり頑張らずにやる。
https://github.com/archlinux/archinstall
([Manjaro](https://manjaro.org/)にDesktop無しのサーバー版があればそれで良かったような、という気もする)

ユーザーの作成やssh周りの設定などは、鍵の登録を自動化しやすかったりパッケージインストールなど諸々のセットアップができるので`cloud-init`を使って行う。

https://cloud-init.io/

(他のディストリビューションでも知見を使い回しやすいのも大きい)

## 検証環境

- Windows11 Pro
    - バージョン23H2(OSビルド22631.3593)
- Hyper-V マネージャー バージョン: 10.0.22621.1
- 使ったarchlinuxのisoファイル:
    - https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2024.05.01/
      にある[archlinux-2024.05.01-x86_64.iso](https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2024.05.01/archlinux-2024.05.01-x86_64.iso)

## 手順

まず、Hyper-Vの有効化はまだであれば

https://learn.microsoft.com/ja-jp/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v#enable-the-hyper-v-role-through-settings

などを参考に行っておく。

Hyper-Vマネージャーを開いて、画面右の「新規」→「仮想マシン」を開いて仮想マシンを作っていく。

![](https://storage.googleapis.com/zenn-user-upload/79817e604016-20240517.png)

仮想マシンの新規作成ウィザードが立ち上がるので、適当に入力していく：

![](https://storage.googleapis.com/zenn-user-upload/4a10cd833a77-20240517.png)

名前は自分がわかりやすいものを適当につける。今回は`archlinux-example`にした。

![](https://storage.googleapis.com/zenn-user-upload/98b35138e09b-20240517.png)

世代は第２世代にしておく。

![](https://storage.googleapis.com/zenn-user-upload/0476bd0341d5-20240517.png)

今回は"Default Switch"を選択する。

他の選択肢との比較については例えば

https://atmarkit.itmedia.co.jp/ait/articles/2008/14/news018.html

などを参照。

![](https://storage.googleapis.com/zenn-user-upload/8cff635f7cd3-20240517.png)

インストールオプションでarchlinuxをインストールするためのisoファイルを指定する。
(仮想マシンに仮想DVDがアタッチされた感じになる)

https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/iso/2024.05.01/

先述の通り今回は↑から取得した。

https://archlinux.org/download/

に他のミラーサイトもあるので適当なところから選んで最新版を取得する。

他の項目は適当に設定する。
(今回、触れてないところは全部デフォルトで設定した)

仮想マシンの新規作成ウィザードでの作業はここまでで終わりだが、
Linux仮想マシンを起動する際はトラップがあり、すぐに起動せずに一旦作成したマシンの「設定」を開く:

![](https://storage.googleapis.com/zenn-user-upload/b59146ec2ae8-20240517.png)

↑Linuxを起動する際は必ず「セキュアブート」をOFFにする
(デフォルトではONになっているが、OFFにしないと起動できない)

セキュアブートONだと↓のようなエラーになる:

![](https://storage.googleapis.com/zenn-user-upload/d837c49804e1-20240518.png)

一方で正しく起動できると↓

![](https://storage.googleapis.com/zenn-user-upload/e220d3b65c0d-20240518.png)

みたいなのが出て、
少し待つと`root@archiso`にログインした状態になる↓:

![](https://storage.googleapis.com/zenn-user-upload/b115c8ea559b-20240517.png)

本来的にはここから

https://wiki.archlinux.jp/index.php/%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%82%AC%E3%82%A4%E3%83%89

などを参考にインストールしていく感じになるが、
冒頭で書いたようにもう少し楽にインストールする方法として`archinstall`コマンド:

https://wiki.archlinux.jp/index.php/Archinstall

が使えるのでこれを使っていく。
先程の`root@archiso`には`archinstall`コマンドへのパスが通っているため、

```sh
archinstall
```

と実行すれば以下のような画面が起動する：

![](https://storage.googleapis.com/zenn-user-upload/403fe732309c-20240517.png)

十字キーでカーソル移動＋適当に各項目を選択・入力すればOKで結構直感的に操作できる。

いくつかだけピックアップしてメモしておく:

![](https://storage.googleapis.com/zenn-user-upload/8d6c845a1c71-20240517.png)

Mirrorsでは、スラッシュ"/"を打ってから"Japan"と入力すればリポジトリに日本のミラーサイトを登録できるので、
好みで設定しておく。

![](https://storage.googleapis.com/zenn-user-upload/4016c9a388ef-20240517.png)

キーボードレイアウトはデフォルトでUS配列となっているので、必要に応じて"Locales"から適宜変更する。
日本語配列は"jp106"なので"/jp"などと入力して検索・選択する。

![](https://storage.googleapis.com/zenn-user-upload/ac4558d9c11b-20240517.png)

"Disk configuration"は必須選択項目で、必ず設定が必要。
今回は"Use a best-effort default partition layout"を選択した。

![](https://storage.googleapis.com/zenn-user-upload/68bfd9c8441f-20240517.png)

作成した仮想ハードディスクの容量とほぼ同様になっている`/dev/sda`を選択する。

![](https://storage.googleapis.com/zenn-user-upload/805e36699d7e-20240517.png)

ファイルシステムは"ext4"を選択した。

![](https://storage.googleapis.com/zenn-user-upload/1452a3b2fece-20240517.png)

`/home`を別パーティションに分けるかどうか。
好みや用途次第だが、今回は"no"を選択した。

![](https://storage.googleapis.com/zenn-user-upload/8d6ee61e0194-20240517.png)

"Profile"で、用途に合わせたものを選ぶと必要そうなものをある程度インストールしてくれる。
今回はホスト(Windows)側からssh接続したいのでTypeは"Server"の"sshd"を選択↑

![](https://storage.googleapis.com/zenn-user-upload/7cc29abf76a2-20240518.png)

"Network configuration"では、ホストからsshしやすくしたいのでデフォルトにはせず、
`Use NetworkManager`を選択する。

これによって、ゲストにログインして`ip a`を叩くなどしてIPアドレス(DHCPなので変わる可能性もあるらしい)をいちいち調べる必要がなくなり、`<設定したホスト名>.mshome.net`を指定すれば良くなる。
(ex. `ssh <username>@<設定したホスト名>.mshome.net`)

![](https://storage.googleapis.com/zenn-user-upload/56432823227a-20240518.png)

"Additional packages"について、インストールしたいパッケージ名を書くとはじめにインストールしてくれるようになる。
(リポジトリに存在しないものを入力するとメッセージを出した上で弾いてくれるため安心)

今回は`cloud-init`を使うため、

- `cloud-init`
    - (後でプロビジョニングする用)
- `cloud-guest-utils`
    - growpart(後からディスクを拡張した際に、自動でパーティションサイズを調整してくれる)などを使えるようにしておく

は最低限入れておく。

また、x11を使いたいため、
x11に必要なもの＋動作確認用のために

- `xorg-server`
- `xorg-apps`
- `xf86-video-fbdev`
    - GUIの表示に必要なビデオドライバー
    - `xf86-video-vesa`でも良いかも(`xf86-video-fbdev` → `xf86-video-vesa`の順で使おうとするらしい)
    - (参考) https://wiki.archlinux.jp/index.php/Xorg
- `xorg-xeyes`
    - 動作確認用

なども入れておく。
(GUIやクリップボード共有機能が一切必要無ければ↑は不要)

また、デフォルトだと結構びっくりするくらい何も入っていない(`less`コマンドも無いしエディタも入っていなかったり)ので、
必要そうなものがあれば入れておく。

あとは"Root password"を適当に設定する。
※ユーザーは後で`cloud-init`で作るため今回は設定しない。rootでのログインは最終的には禁じた方が安心だが、最初はrootでログインする手段が残っている方がやりやすく、後から出来なくすれば良いというスタンスを取っている。

最終的に↓のような感じ:

![](https://storage.googleapis.com/zenn-user-upload/fcf028abfd65-20240518.png)

:::details (参考) 設定の保存

"Save configuration"を選択すると、
上記の手順で選択・入力した内容をjsonファイルとしてエクスポートできる。

https://github.com/archlinux/archinstall?tab=readme-ov-file#running-from-a-declarative-configuration-file-or-url

によると`archinstall`コマンド実行時に引数としてファイルの読み込みが可能なので、
今後同様の作業を行う可能性がある場合はここで保存しておくと良い。

"Save all"を選択し、適当なパスを指定するとそこに`user_configuration.json`および`user_credentials.json`(※パスワードはハッシュ化などはされておらず平文で書き込まれているので注意)を保存できる。

インストール作業完了後、すぐにrebootせずに、例えば、
まずは仮想マシンのIPアドレスを`ip a`などで調べておき、
保存したファイルがあるディレクトリで

```sh
python -m http.server
```

を実行し、8000ポートで公開すると、

![](https://storage.googleapis.com/zenn-user-upload/19bb51723612-20240517.png)

![](https://storage.googleapis.com/zenn-user-upload/38e31da4bac8-20240517.png)

Windows側で"http://<先ほど調べたIPアドレス>:8000"にアクセスすると、
`user_configuration.json`と`user_configuration.json`が見えるのでここでダウンロードしておく。

:::

あとは"Install"を選択し、Enterを押すとインストールが開始される：

![](https://storage.googleapis.com/zenn-user-upload/34c6fb8172d8-20240518.png)

無事に一通り終わると以下のように聞かれる:

![](https://storage.googleapis.com/zenn-user-upload/7a0e25f19fc7-20240517.png)

yesを選択するとインストールしたメディアに`chroot`して必要な初期セットアップができる。
今回は`cloud-init`のservice有効化をしたいのでyesを選択する。

cloud-initを有効化するため、

```sh
systemctl enable cloud-init
systemctl enable cloud-init-local
systemctl enable cloud-config
systemctl enable cloud-final
```

を順次実行する。

![](https://storage.googleapis.com/zenn-user-upload/02013d407dee-20240517.png)

(他にも初期セットアップとしてやりたいことがあれば適宜やっておく)

exitで抜けると"Installation completed without any errors. You may now reboot."と出る。

![](https://storage.googleapis.com/zenn-user-upload/1a785efa1ab7-20240517.png)

先ほど(参考)と書いたところで説明したように`user_configuration.json`と`user_credentials.json`を保存したい場合はすぐにrebootやshutdownをせずに、適宜これらのファイルを回収しておく。

ここまで一通り終わったら一旦shutdownする。
(今回、cloud-initで初期設定を行うために新規で仮想DVDドライブをアタッチするのでrebootはしない)

![](https://storage.googleapis.com/zenn-user-upload/5d03136dd1d8-20240517.png)

仮想マシンにアタッチされているインストールメディア(isoファイル)を除去し、
代わりに先ほど`genisoimage`を使って作成したisoファイルをアタッチする。
